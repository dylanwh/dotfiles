#!/usr/bin/env perl
use strict;
use warnings;
use IO::File;
$|++;
my %passwd;
my %pawns;

while (<ARGV>) {
	if (/pawn \$([A-Z]+) is for (.+)/) {
		my ($var, $desc) = ($1, $2);
		print "$var for $desc ($ARGV): \n";
		if ($passwd{$desc}) {
			$pawns{$ARGV}{$var} = $passwd{$desc};
		} else {
			system('stty', '-echo');
			my $pass = <STDIN>;
			chomp $pass;
			$passwd{$desc} = $pawns{$ARGV}{$var} = $pass;
			system('stty', 'echo');
		}
	}
}

foreach my $file (keys %pawns) {
	my $in = new IO::File($file) or die "Cannot open $file!\n";
	my $newfile = $file;
	$newfile =~ s/\.pwn$//;
	print "$newfile\n";
	my $out = new IO::File($newfile, "w");
	while (<$in>) {
		foreach my $var (keys %{ $pawns{$file} }) {
			s/\$$var/$pawns{$file}{$var}/g;
		}
		$out->print($_);
	}
	$out->close;
	$in->close;
	chmod(0600, $newfile);
}

