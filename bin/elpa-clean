#!/usr/bin/env perl
use strict;
use warnings;
use File::Basename;
use JSON;
use v5.16;

my $prefix = glob("~/.emacs.d/elpa");

my @packages = map { extract_info($_) } grep { !/(?:archives|gnupg)$/ } grep { -d $_ } glob("$prefix/*");
my %package;
foreach my $pkg (@packages) {
    push @{ $package{$pkg->{name} } }, $pkg;
}
my @bad_packages = map {
    my @list = sort { $a->{base} cmp $b->{base} } @$_;
    pop @list;
    @list;
} grep { @$_ > 1 } values %package;

system("rm", "-frv", map { "$prefix/$_->{base}" } @bad_packages);

sub extract_info {
    my $file = shift;
    my $base = basename($file);
    my ($name, $version) = $base =~ /^(.+)-(\d+(?:\.\d+)?)$/;
    if ($name) {
        return { name => $name, version => $version, dir => dirname($file), base => $base };
    }
    else {
        return { wtf => $base };
    }
}

