#!/usr/bin/env perl
use strict;
use Getopt::Long qw( :config gnu_getopt );

my $TERM = 'urxvt';
my ($title, $name, $dtach, $host, $raw);

foreach (@ARGV) { if ($_ eq '-e') { $_ = '--'; last } }

GetOptions(
    'title|t=s' => \$title,
    'name|n=s'  => \$name,
    'dtach|d'   => \$dtach,
    'host|h=s'  => \$host,
    'raw|r'     => \$raw,
);

my (@run) = @ARGV;

unless ($title) {
    $title = $run[0];
    $title =~ s/[^A-Za-z]+/ /g;
}

unless ($name) {
    $name = $run[0];
    $name =~ s/\W+/_/g;
}

if ($dtach) {
    my @dtach = (
        'dtach',
        '-A'  => "$ENV{HOME}/.dtach/$name",
        '-r'  => 'winch',
        '-Ez'
    );
    unshift @run, @dtach;
}

if (not $raw) {
    if (@run) {
        unshift @run, '-e';
    }

    if (-e "$ENV{HOME}/.outside") {
        $name = 'outside';
    }
    exec($TERM =>
        option(-name => $name),
        option(-title => $title), 
        @run);
}
else {
    exec(@run);
}

sub option {
    my ($key, $val) = @_;
    return ($key, $val) if $val;
    return ();
}
