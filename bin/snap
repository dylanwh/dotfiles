#!/usr/bin/env perl
use strict;
use warnings;

use Tk;
use Tk::PNG;
use Tk::Photo;
use File::Copy qw(move);
use File::Temp ();
require Tk::ErrorDialog;

my $msg = "Press Snap and click\non any window.";
my $mw = new Tk::MainWindow(-title => "Snap");
my $lab = $mw->Label(-text => $msg);

my $snap = $mw->Button(-text => "Snap", -command => \&snap);
$lab->pack;
$snap->pack;


MainLoop();


sub snap {
	my $fh = new File::Temp (
		UNLINK => 0,
		TEMPLATE => "snapshotXXXX",
		SUFFIX => ".png",
		DIR  => $ENV{TEMPDIR} || '/tmp',
	);
	my $file = "$fh";
	close $fh;
	
	$mw->destroy;
	system('import', '-delay' => '0', $file);
	$mw = new Tk::MainWindow(-title => "Preview");

	my $img = $mw->Photo(-format => 'png', -file => $file);
	#my $can = $mw->Scrolled('Canvas', -scrollbars => 'seo');
	
	my $label = $mw->Label(-image => $img);
	#$can->pack(-expand => 1, -fill => 'both');
	$label->grid(-columnspan => 2);
	my $but1 = $mw->Button(-text => "Save", -command => [\&save_file, $file]);
	my $but2 = $mw->Button(-text => "Close", -command => sub { $mw->destroy });

	$but1->grid(-column => 0, -row => 1, -sticky => 'e');
	$but2->grid(-column => 1, -row => 1, -sticky => 'w');

	
}

sub save_file {
	my $file = shift;
	my $savefile = $mw->getSaveFile(
		-initialfile => "screenshot",
		-filetypes => [['PNG','.png']],
		-defaultextension => ".png",
	);
	if ($savefile) {
		move($file, $savefile);
	} else {
		unlink($file) or die "Can't remove $file!";
	}
	$mw->destroy();
}
