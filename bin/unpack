#!/usr/bin/env zsh

file=$1
dir=${file:r}
ext=${file:e}

case $dir in
    *.tar) 
        dir=${dir:r}
        ext="tar.$ext"
    ;;
esac

if [[ -e $dir ]]; then
    integer i=0
    while [[ -e "${dir}_$i" ]]; do
        (( i++ ))
    done
    dir="${dir}_$i"
fi

mkdir $dir.tmp || exit 1

case $ext in
    zip)
        unzip -q -d $dir.tmp $file ;;
    tar.*|*.tgz|*.tbz2|*.txz)
        tar -C $dir.tmp -xf $file  ;;
    xls)
        xls-explode $file ;;
esac

if [[ -d $dir.tmp ]]; then
    integer files=$(ls -A $dir.tmp | wc -l)
    echo "files: $files"

    if (( files == 1 )); then
        mv $dir.tmp/*(/) $dir
        rmdir $dir.tmp
    else
        mv $dir.tmp $dir
    fi
fi
