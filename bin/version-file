#!/usr/bin/env perl
use strict;
use warnings;
use POSIX 'strftime';

my $file    = shift || 'stdin';
my $version = shift || 1;

my $format = "%s-%s-v%d%s";
my $date_format = '%Y-%m-%d';

my $suffix_re = qr/
    \. \w+ (?: \. (?: Z|gz|bz2|xz ) )?
/ix;

my ($ext) = $file =~ m/($suffix_re)$/s;
my $prefix = $ext ? substr($file, 0, length($file)-length($ext)) : $file;
my $vfile;

do {
    $vfile = sprintf($format,
        $prefix,
        strftime($date_format, localtime),
        $version++,
        $ext || '',
    );
} until (! -f $vfile);

rename($file, $vfile);
