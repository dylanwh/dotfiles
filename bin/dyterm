#!/usr/bin/env perl
use strict;
use warnings;
use File::Basename;
use Getopt::Long qw( :config gnu_getopt );
use IO::File;
use autodie;

my $TERM  = 'urxvt';
my ($name, $eep, $chdir, $auto_chdir);

if (-f "$ENV{HOME}/.outside") {
    $name = 'outside';
}

foreach (@ARGV) {
    if ($_ eq '-e') {
        $_ = '--';
        last 
    }
    elsif (/^-name/) {
        $_ = '--name';
    }
    elsif (/^-e(.+)$/) {
        unshift @ARGV, "-$1" if $1;
        $_ = '--';
        last;
    } 
}

GetOptions(
    'name|n=s'     => \$name,
    'e'            => \$eep,
    'chdir|C=s'    => \$chdir,
    'auto-chdir|A' => \$auto_chdir,
);


if (not $chdir and $auto_chdir) {
    if (-f "$ENV{XDG_RUNTIME_DIR}/last_cwd") {
        open my $fh, "<", "$ENV{XDG_RUNTIME_DIR}/last_cwd";
        my $cwd = readline $fh;
        chomp $cwd;
        close $fh;
        $chdir = $cwd;
    }
}

my (@run) = @ARGV;
chdir $chdir if $chdir;
unshift @run, '-e' if @run;

unless ($name) {
    if (@ARGV) {
        $name = $ARGV[0];
    }
}

run($TERM,
    $name ? (-name => $name) : (),
    @run
);

sub run { 
    exec(@_);
}
